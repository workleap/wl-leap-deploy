# Example leap-deploy.yaml for deploying multiple workloads with different configurations
# This file demonstrates how to define workloads, their deployment settings,
# and environment/region-specific parameters using the leap-deploy GitHub Action.
#
# CONFIGURATION INHERITANCE AND PRECEDENCE
# ========================================
# This schema supports a layered configuration approach where settings cascade from 
# general (defaults) to specific (environment/region). The precedence order is:
#
#   1. workloads.<name>.regions.<region>.environments.<env> (highest - most specific)
#   2. workloads.<name>.regions.<region> (region-specific settings)
#   3. workloads.<name>.environments.<env> (environment-specific, cross-region)
#   4. workloads.<name> (workload-level settings)
#   5. defaults (lowest - global base settings)
#
# Each level can contain the same "workloadConfig" structure, and more specific
# levels override less specific ones through deep merging. This minimizes repetition
# while allowing precise control where needed.

# ==============================================================================
# IDENTIFIER
# ==============================================================================
# Unique identifier for this deployment configuration - Required to uniquely identify
# the set of workloads being deployed.
version: "0"
id: foobar

# ==============================================================================
# WORKLOADS
# ==============================================================================
# Define all workloads that are deployed together as a unit-of-work.
workloads:

  # --------------------------------------------------------------------------
  # Workload: workleap-sample-api
  # --------------------------------------------------------------------------
  # API service with region and environment-specific configurations
  workleap-sample-api:
    
    # Workload-level config (applies to all regions/environments unless overridden)
    type: api # {null|api|worker}

    image:
      repository: wl-mono-repo
      # tag defaults to GitHub/Terraform values
    
    ingress:
      pathPrefix: /api

    # Environment-specific overrides (apply across all regions)
    environments:
      dev:
        replicas: 1
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
        autoscaling:
          horizontal:
            minReplicas: 1
            maxReplicas: 2
      
      staging:
        replicas: 2
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
      
      prod:
        replicas: 3
        autoscaling:
          horizontal:
            minReplicas: 3
            maxReplicas: 10
        resources:
          requests:
            cpu: 200m
            memory: 256Mi

    # Region-specific overrides
    regions:
      
      na:
        # Region + Environment specific (most specific level)
        environments:
          prod:
            # North America prod needs extra capacity
            replicas: 5
            autoscaling:
              horizontal:
                minReplicas: 5
                maxReplicas: 20
      
      eu:
        environments:
          prod:
            # EU has stricter data residency, different namespace
            namespace: eu-prod
            labels:
              data-residency: eu

  # --------------------------------------------------------------------------
  # Workload: workleap-sample-worker
  # --------------------------------------------------------------------------
  # Background worker with simpler configuration (inherits most from defaults)
  workleap-sample-worker:
    
    annotations:
      apps.workleap.com/flavor: worker
    
    # Workers don't need ingress
    ingress: null
    
    image:
      repository: wl-mono-repo
    
    environments:
      dev:
        replicas: 1
        autoscaling:
          horizontal:
            enable: false
      
      prod:
        replicas: 3
        resources:
          requests:
            cpu: 500m
            memory: 512Mi

  # --------------------------------------------------------------------------
  # Workload: workleap-minimal-service
  # --------------------------------------------------------------------------
  # Example of a workload that uses mostly defaults with minimal overrides
  workleap-minimal-service:
    
    annotations:
      apps.workleap.com/flavor: service
    
    image:
      repository: minimal-service
    
    # Only override prod settings, everything else uses defaults
    environments:
      prod:
        replicas: 4
    